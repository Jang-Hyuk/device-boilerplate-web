<!DOCTYPE html>
<html>
  <head>
<!-- css -->
<link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"
    />
<link
      href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css"
      rel="stylesheet"
    />

    <!-- Default Js -->

    <%- include("../master/head.ejs") %>
    <script src="/js/contents/master/mainUtil.js"></script>
    <script src='/js/lodash'></script>
    <!-- <script src="/js/hichart/dark-unica.theme.js"></script> -->

    <!-- toggle library -->
    <script src="/js/bootstrap.min.js"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <!-- SVG Map 을 생성하기 위한 필수 Library -->
    <script src="js/svg/svg.js"></script>
    <script src="js/svg/svg.filter.js"></script>
    <script src="js/jquery.panzoom.js"></script>
    <script src="js/jquery.mousewheel.js"></script>

    <!-- SVG Map을 생성하고 관리하기 위한 Core Library -->
    <script src="/map/muan100kW.js"></script>
    <script src="js/drawSvg/drawSvg.js"></script>

  </head>

  <body>
    <div id="wrap" class="wrap hidden">
      <!-- Header -->
      <%- include("../master/header.ejs") %>
      <!--메인-->
      <div class="container_body ">
        <div class="container_row mb_50rem">
          <div class="report_category">
            <button
              type="button"
              name="selectMode"
              data-value="structureMode"
              class="btn btn-success"
            >
              구성도
            </button>
            <button
              type="button"
              name="selectMode"
              data-value="tableMode"
              class="btn btn-default"
            >
              테이블
            </button>
          </div>
        </div>
        <!-- 명령 상태, 결과 -->
        <div class="container_row default_search_area">
          <p>
            장치 연결 상태:
            <span id="device_connected_stauts"></span>
          </p>
          <h2>
            <span>명령 처리 결과:</span>
            <span id="test_alert" class="color_red"></span>
          </h2>
        </div>
        <!-- 단일 제어 명령 -->
        <div class="container_row flex_jus_end default_search_area" name="controlArea" data-area="single" >
            <div class="search_area">
              <div class="search_box search_range_box">
                <span class="search_title">명령 형식</span>
                <select class="form-control" name="cmdFormatSelector" >
                  <option value="single">단일 제어</option>
                  <option value="set">설정 제어</option>
                  <option value="flow">염수 이동</option>
                  <option value="scenario">시나리오</option>
                </select>
              </div>
              <div class="search_box search_range_box">
                <span class="search_title">장치 타입</span>
                <select class="form-control" id="singleDeviceCate"> </select>
              </div>
              <div class="search_box search_range_box">
                <span class="search_title">장치 목록</span>
                <select class="form-control" id="singleDeviceList">
                  <option value=""></option>
                </select>
              </div>
              <div class="search_box search_range_box">
                <span class="search_title">제어 형식</span>
                <select class="form-control">
                  <option value="1">Open / On</option>
                  <option value="0">Close / Off</option>
                </select>
              </div>
              <div class="submit_box ml_2rem">
                <button type="button" class="btn btn-success" onclick="" id="">
                  제어
                </button>
                <button type="button" class="ml_1rem btn btn-danger" onclick="" id="">
                  취소
                </button>
              </div>
            </div>
        </div>
        <!-- 설정 제어 명령 -->
        <div class="container_row flex_jus_end default_search_area" name="controlArea" data-area="set" style="display: none">
            <div class="search_area">
              <div class="search_box search_range_box">
                <span class="search_title">명령 형식</span>
                <select class="form-control" name="cmdFormatSelector" >
                  <option value="single">단일 제어</option>
                  <option value="set">설정 제어</option>
                  <option value="flow">염수 이동</option>
                  <option value="scenario">시나리오</option>
                </select>
              </div>
              <div class="search_box search_range_box">
                <span class="search_title">명령 종류</span>
                <select class="form-control">
                  <option value="closeAllDevice">모든 장치 폐쇄</option>
                  <option value="rainMode">우천 대피</option>
                </select>
              </div>
              <div class="user_box report_category  ml_2rem">
                <button type="button" class="btn btn-success mr_1rem" onclick="" id="">
                  제어
                </button>
                <button type="button" class="ml_1rem btn btn-danger" onclick="" id="">
                  취소
                </button>
              </div>
            </div>
        </div>
        <!-- 흐름 제어 명령 -->
        <div class="container_row flex_jus_end default_search_area" name="controlArea" data-area="flow" >
            <div class="search_area">
              <div class="search_box search_range_box">
                <span class="search_title">명령 형식</span>
                <select class="form-control" name="cmdFormatSelector" >
                  <option value="single">단일 제어</option>
                  <option value="set">설정 제어</option>
                  <option value="flow">염수 이동</option>
                  <option value="scenario">시나리오</option>
                </select>
              </div>
              <div class="search_box search_range_box">
                <span class="search_title">시작지</span>
                <select class="form-control" id="flowCmdSrcPlace"> </select>
              </div>
              <div class="search_box search_range_box">
                <span class="search_title">도착지</span>
                <select class="form-control" id="flowCmdDestPlace"> </select>
              </div>
              <div class="user_box report_category  ml_2rem">
                <button type="button" class="btn btn-success" onclick="" id="">
                  제어
                </button>
                <button type="button" class="ml_1rem btn btn-danger" onclick="" id="">
                  취소
                </button>
              </div>
            </div>
        </div>
        <!-- 시나리오 명령 -->
        <div class="container_row flex_jus_end default_search_area" name="controlArea" data-area="scenario">
            <div class="search_area">
              <div class="search_box search_range_box">
                <span class="search_title">명령 형식</span>
                <select class="form-control" name="cmdFormatSelector">
                  <option value="single">단일 제어</option>
                  <option value="set">설정 제어</option>
                  <option value="flow">염수 이동</option>
                  <option value="scenario">시나리오</option>
                </select>
              </div>
              <div class="search_box search_range_box">
                <span class="search_title">시나리오</span>
                <select class="form-control"> </select>
              </div>
              <div class="user_box report_category  ml_2rem">
                <button type="button" class="btn btn-success" onclick="" id="">
                  제어
                </button>
                <button type="button" class="ml_1rem btn btn-danger" onclick="" id="">
                  취소
                </button>
              </div>
            </div>
        </div>
        <!-- 명령 목표 -->
        <div class="container_row flex_jus_end default_search_area" >
          <div class="search_area">
            <div class="search_box search_range_box">
              <span class="search_title">제한 시간(초)</span>
              <div class="search_body">
                <input type="text" class="input_tre" placeholder="Infinity" />
              </div>
            </div>
            <div class="search_box search_range_box">
              <span class="search_title">장소 타입</span>
              <select class="form-control"> </select>
            </div>
            <div class="search_box search_range_box">
              <span class="search_title">장소</span>
              <select class="form-control"> </select>
            </div>
            <div class="search_box search_range_box">
              <span class="search_title">센서 종류</span>
              <select class="form-control"> </select>
            </div>
            <div class="search_box search_range_box">
              <span class="search_title">달성 목표치</span>
              <div class="search_body">
                <input type="text" class="input_tre" placeholder="없음" />
              </div>
            </div>
            <div class="search_box search_range_box">
              <span class="search_title">목표 범위</span>
              <select class="form-control">
                <option value="UPPER">이상</option>
                <option value="EQUAL">동일</option>
                <option value="LOWER">이하</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Content -->
        <div class="container_row flex_dir_col">
          <!-- tableContent -->
          <div id="tableMode" hidden>
            <div class= "flex_jus_center rtsp_container" >
              <div id="contents" class="row row_st_line min_h_780" style="padding: 30%" >
                <div class=" panel panel-default">
                  <!-- Default panel contents -->
                  <div class="panel-heading">명령 목록</div>
                  <div class="panel-body">
                    갱신 시간:
                    <span id="CMD_order_date"></span>
                  </div>
                  <!-- Table -->
                  <table id="CMD_order_list" class="table">
                    <thead>
                      <tr>
                        <th data-field="wrapCmdFormat">명령 형식</th>
                        <th data-field="wrapCmdType">명령 타입</th>
                        <th data-field="wrapCmdStep">명령 단계</th>
                        <th data-field="wrapCmdId">명령 ID</th>
                        <th data-field="wrapCmdName">명령 이름</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div> 
              <div id="contents" class="row row_st_line min_h_780" style="padding: 30%" >
                <div class="panel panel-default">
                  <!-- Default panel contents -->
                  <div class="panel-heading">장치 상태 정보 목록</div>
                  <div class="panel-body">
                    갱신 시간:
                    <span id="CMD_node_date"></span>
                  </div>
                  <!-- Table -->
                  <table id="MS_node_list" class="table">
                    <thead>
                      <tr>
                        <th data-field="nd_target_name">장치 명</th>
                        <th data-field="node_id">장치 ID</th>
                        <th data-field="place_name_list">관련 장소</th>
                        <th data-field="data">데이터</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div> 
            </div>
          </div>
          <!-- structure Content -->
          <div id="structureMode">
            <div class="default_area pt_1rem">
              <!-- panzoom, mode select -->
              <div id="zoom" class="zoom_box" >
                <button id="zoom-in" class="btn btn-default btn-sm mr_1rem" >
                  <span class="glyphicon glyphicon-zoom-in"></span> Zoom-in
                </button>
                <button id="zoom-out" class="btn btn-default btn-sm mr_1rem" >
                  <span class="glyphicon glyphicon-zoom-out"></span> Zoom-out
                </button>
                <button id="reset" class="btn btn-default btn-sm mr_1rem" >
                  <span class="glyphicon glyphicon-refresh"></span> Reset
                </button>
                <input id="placeNodeChangeNameToogleBtn" type="checkbox" data-toggle="toggle" />
                <select class="form-control w_auto ml_1rem" id='controlMode'>
                  <option value="view" selected>뷰 모드</option>
                <option value="control">제어 모드</option>
                <option value="develop">개발 모드</option>
                </select>
              </div>
              <!-- canvas -->
              <div>
                <div id="canvas"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--하단1-->

      <%- include("../master/footer.ejs") %>
    </!--하단1-->

    <script>
      var controlInfo = <%- JSON.stringify(controlInfo) %>;
      var setCmdList = controlInfo.setCmdList;
      var flowCmdList = controlInfo.flowCmdList;
      var scenarioCmdList = controlInfo.scenarioCmdList;
      var deviceDomList = <%- JSON.stringify(deviceDomList) %>;

      
      // Single 제어 장치 타입 선택시 이벤트
      $('#singleDeviceCate').on('change', function(event){
        return handleDeviceCategory(this.value);
      })

      // Flow 제어 시작지 선택시 이벤트
      $('#flowCmdSrcPlace').on('change', function(event){
        return handleFlowSrcPlace(this.value);
      })

      // Single Cmd: 제어 장치 타입 Dom 설정
      function setDeviceCategory() {
        // 돔 생성
        $('#singleDeviceCate').html(_.map(deviceDomList, 'category'));

        // handleDeviceCategory() 실행 시킴
        $('#singleDeviceCate').trigger('change');
      }

      // Single Cmd: 제어 장치 타입 변경 시 장치 목록 자동 변경
      function handleDeviceCategory(category) {
        $('#singleDeviceList').html(_.find(deviceDomList, {type: category}).list)
      }


      // Flow Cmd: 시작 장소 세팅
      function setFlowSrcPlace() {
        const placeTemplate = _.template('<option value="${ srcPlaceId }"> ${ srcPlaceName }</option>');

        $('#flowCmdSrcPlace').html(_.map(flowCmdList, placeTemplate));

        // handleFlowSrcPlace() 실행 시킴
        $('#flowCmdSrcPlace').trigger('change');
      }

      // Flow Cmd: 시작 장소 선택 시 실행하는 함수
      function handleFlowSrcPlace(placeId) {
        // console.log('handleFlowSrcPlace')
        // const placeTemplate = _.template('<option value="${ destPlaceId }"> ${ destPlaceName }</option>');


        // console.log('placeId', placeId)
        // console.log(_.find(flowCmdList, {srcPlaceId: placeId}).destList)


        // $('#flowCmdDestPlace').html(_.find(flowCmdList, {srcPlaceId: placeId}).destList.map(placeTemplate));
      }


      setDeviceCategory();
      setFlowSrcPlace();

    </script>

    <!-- 구성도 페이지 형식 선택 -->
    <script>
      var $selectModeBtns = $('button[name=selectMode]');

      $selectModeBtns.on('click', function(event) {
        var currValue = $(this).data('value');
        
        $selectModeBtns.each(function(index, selectModeBtn) {
          var btnValue = $(selectModeBtn).data('value');

          if(currValue === btnValue) {
            $(selectModeBtn).addClass('btn-success');
            $(selectModeBtn).removeClass('btn-default');
            $('#' + btnValue).removeAttr('hidden');
          } else {
            $(selectModeBtn).addClass('btn-default');
            $(selectModeBtn).removeClass('btn-success');
            $('#' + btnValue).attr('hidden', 'hidden');
          }
        })
      });
    </script>

    <!-- structure Content 세팅 -->
    <script>
      drawSvgBasePlace('canvas'); // 멥 그리기
      setPanzoom(); // 줌 기능 세팅
  
        //모드 선택 설렉트 박스 and 한/영 토글 버튼
      $('#controlMode, #placeNodeChangeNameToogleBtn').change(function() {
        var selectedMode = this.value
        var isChecked = $('#placeNodeChangeNameToogleBtn').prop('checked'); // 체크 상태 false: off, true: on
  
        $(`#canvas`).empty(); // svg가 그려진 공간 초기화
        drawSvgBasePlace('canvas', isChecked); // 초기화 후 다시 그리기 (체크 상태 포함)
        bindingClickNodeEvent('', selectedMode); // 장치, 센서 클릭 이벤트 다시 바인딩

        // ↓ 다시 그려진 map에 데이터를 다시 뿌려준다.
        });
  
        // jquery panzoom 옵션 세팅
        function setPanzoom() {
          var svgMap = SVG.get('svgCanvas'); //id가 svgCanvas인 svg 요소 선택
          var $canvas = $('#canvas');
          var matrix = `matrix(1, 0, 0, 1, 0, 0)`; // panzoom 기본 zoom 설정
          var filter = 'win16|win32|win64|mac';
  
          //모바일, pc 접속 분별하여 zoom in/out 활셩 여부 설정
          if (0 > filter.indexOf(navigator.platform.toLowerCase())) {
            // mobile panzoom option  
            $canvas.panzoom({
                disablePan: true,
                disableZoom: true,
                startTransform: matrix,
              });
            // zoom(in,out), reset 버튼 숨김
            $('#zoom-out', '#zoom-in', '#reset').hide();
          } else {
            // pc panzoom
            $canvas.panzoom({
              $reset: $('#reset'),
              cursor: 'context-menu',
              startTransform: matrix,
            });
  
            // mousewheel option
            $canvas.panzoom().on('mousewheel.focal', function(e) {
              const delta = e.delta || e.originalEvent.wheelDelta;
              const zoomOut = delta ? delta < 0 : e.originalEvent.deltaY > 0;
                
              e.preventDefault();

              $canvas.panzoom('zoom', zoomOut, {
                animate: false,
                focal: e,
              });
            });

            // zoom in, out 기능 적용
            $('#zoom-in').click(function(e) {
              $canvas.panzoom('zoom', {});
            });
            $('#zoom-out').click(function(e) {
              $canvas.panzoom('zoom', 'zoomOut', {});
            });
          }
        }
    </script>

      <!-- 명령 형식 선택 이벤트 -->
    <script>
      $('div[name=controlArea').each(function(index, value){
        $(value).data('area') !== 'single' && $(value).hide()
      })

      $('select[name="cmdFormatSelector"]').on('change', function() {
        var selectedForm = this.value // 선택된 명령 형식
        var $controlArea = $('div[name=controlArea')
      
        $('select[name="cmdFormatSelector"]').val(selectedForm).attr('selected','selected')

        $controlArea.each(function(index, searchArea){
          $(searchArea).data('area') === selectedForm ?$(searchArea).fadeIn() : $(searchArea).hide()
        })
      })
    </script>
  </body>
</html>
